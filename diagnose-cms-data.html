<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS Data Diagnostics - Estalara</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-4">üîç Diagnostyka Danych CMS</h1>
            <p class="text-gray-600 mb-6">Ten skrypt sprawdza stan danych w localStorage i pomaga w migracji do nowego systemu LIVE Properties.</p>
            
            <div class="space-y-4">
                <button onclick="checkData()" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-semibold">
                    ‚úÖ Sprawd≈∫ Stan Danych
                </button>
                
                <button onclick="forceMigration()" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold">
                    üîÑ Wymu≈õ Migracjƒô
                </button>
                
                <button onclick="clearAndReload()" class="w-full bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 font-semibold">
                    üóëÔ∏è Wyczy≈õƒá i Prze≈Çaduj (Reset do domy≈õlnych)
                </button>
            </div>
        </div>
        
        <div id="output" class="bg-gray-900 text-green-400 font-mono text-sm p-6 rounded-lg min-h-[400px] overflow-auto">
            <p>Kliknij przycisk powy≈ºej aby rozpoczƒÖƒá diagnostykƒô...</p>
        </div>
    </div>

    <script>
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const color = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'warning': 'text-yellow-400',
                'error': 'text-red-400'
            }[type] || 'text-green-400';
            
            output.innerHTML += `<div class="${color}">${message}</div>`;
            output.scrollTop = output.scrollHeight;
        }

        function clearLog() {
            document.getElementById('output').innerHTML = '';
        }

        function checkData() {
            clearLog();
            log('=== ROZPOCZYNAM DIAGNOSTYKƒò ===', 'info');
            log('');
            
            const data = localStorage.getItem('estalaraAdminData');
            
            if (!data) {
                log('‚ùå Brak danych w localStorage!', 'error');
                log('To mo≈ºe oznaczaƒá, ≈ºe CMS nie zosta≈Ç jeszcze u≈ºyty.', 'warning');
                log('Spr√≥buj otworzyƒá cms.html i wr√≥ciƒá tutaj.', 'warning');
                return;
            }
            
            let parsed;
            try {
                parsed = JSON.parse(data);
                log('‚úÖ Dane znalezione w localStorage', 'success');
            } catch (e) {
                log('‚ùå B≈ÇƒÖd parsowania danych JSON: ' + e.message, 'error');
                return;
            }
            
            log('');
            log('--- WERSJA DANYCH ---', 'info');
            log(`Aktualna wersja: ${parsed.version || 'BRAK'}`);
            log(`Wymagana wersja: 4`);
            if (parsed.version < 4) {
                log('‚ö†Ô∏è Dane majƒÖ starszƒÖ wersjƒô! Potrzebna migracja.', 'warning');
            } else {
                log('‚úÖ Dane majƒÖ aktualnƒÖ wersjƒô', 'success');
            }
            
            log('');
            log('--- STARE PROPERTIES (deprecated) ---', 'info');
            if (parsed.properties) {
                log(`Znaleziono ${parsed.properties.length} starych properties`);
                parsed.properties.forEach((prop, i) => {
                    log(`  ${i+1}. ${prop.title} (ID: ${prop.id})`);
                });
            } else {
                log('Brak starych properties');
            }
            
            log('');
            log('--- NOWE LIVE PROPERTIES ---', 'info');
            if (parsed.liveProperties) {
                log(`‚úÖ Znaleziono ${parsed.liveProperties.length} liveProperties`, 'success');
                parsed.liveProperties.forEach((prop, i) => {
                    log(`  ${i+1}. ${prop.title} (ID: ${prop.id})`);
                });
            } else {
                log('‚ùå Brak liveProperties! Potrzebna migracja.', 'error');
            }
            
            log('');
            log('--- REKOMENDACJE ---', 'info');
            if (!parsed.liveProperties || parsed.liveProperties.length === 0) {
                log('üîß Kliknij "Wymu≈õ Migracjƒô" aby przenie≈õƒá dane', 'warning');
            } else if (parsed.version < 4) {
                log('üîß Zaktualizuj wersjƒô danych do 4', 'warning');
            } else {
                log('‚úÖ Wszystko wyglƒÖda dobrze! Spr√≥buj prze≈Çadowaƒá CMS (Ctrl+Shift+R)', 'success');
            }
            
            log('');
            log('=== DIAGNOSTYKA ZAKO≈ÉCZONA ===', 'info');
        }

        function forceMigration() {
            clearLog();
            log('=== WYMUSZANIE MIGRACJI ===', 'info');
            log('');
            
            const data = localStorage.getItem('estalaraAdminData');
            
            if (!data) {
                log('‚ùå Brak danych w localStorage!', 'error');
                log('Nie ma czego migrowaƒá. Otw√≥rz cms.html najpierw.', 'warning');
                return;
            }
            
            let parsed;
            try {
                parsed = JSON.parse(data);
            } catch (e) {
                log('‚ùå B≈ÇƒÖd parsowania danych: ' + e.message, 'error');
                return;
            }
            
            log('Sprawdzam dane...');
            
            // Perform migration
            if (!parsed.liveProperties || parsed.liveProperties.length === 0) {
                if (parsed.properties && parsed.properties.length > 0) {
                    log(`Kopiujƒô ${parsed.properties.length} properties do liveProperties...`);
                    
                    parsed.liveProperties = parsed.properties.map(prop => ({
                        id: prop.id,
                        title: prop.title,
                        location: prop.location,
                        price: prop.price,
                        description: prop.description,
                        image: prop.image,
                        link: prop.link || 'https://app.estalara.com'
                    }));
                    
                    log(`‚úÖ Skopiowano ${parsed.liveProperties.length} kafelk√≥w`, 'success');
                } else {
                    log('‚ùå Brak starych properties do skopiowania', 'error');
                    log('Tworzƒô domy≈õlne liveProperties...', 'warning');
                    
                    // Create default liveProperties
                    parsed.liveProperties = [
                        {
                            id: 1,
                            title: "Modern Apartment in C√°diz",
                            location: "C√°diz, Spain",
                            price: 450000,
                            image: "https://kimi-web-img.moonshot.cn/img/talatiandpartners.com/952038c4e2cdd1b53bd4fa58a12aa8472e239da8.webp",
                            description: "Stunning property in the heart of C√°diz with ocean views and modern amenities.",
                            link: "https://app.estalara.com/listing/-cadiz-cadiz-na-d19331b5-846d-4139-a78e-2d9695ff73d0"
                        }
                    ];
                    
                    log('‚úÖ Utworzono domy≈õlne liveProperties', 'success');
                }
            } else {
                log('‚ÑπÔ∏è liveProperties ju≈º istniejƒÖ, pomijam migracjƒô', 'info');
            }
            
            // Update version
            log('Aktualizujƒô wersjƒô do 4...');
            parsed.version = 4;
            
            // Save to localStorage
            try {
                localStorage.setItem('estalaraAdminData', JSON.stringify(parsed));
                log('‚úÖ Dane zapisane pomy≈õlnie!', 'success');
                log('');
                log('üéâ MIGRACJA ZAKO≈ÉCZONA!', 'success');
                log('');
                log('Teraz:', 'info');
                log('1. Zamknij tƒô kartƒô', 'info');
                log('2. Otw√≥rz cms.html', 'info');
                log('3. Kliknij zak≈Çadkƒô "üî¥ LIVE Properties"', 'info');
                log('4. Je≈õli nadal nie widzisz zmian, naci≈õnij Ctrl+Shift+R', 'info');
            } catch (e) {
                log('‚ùå B≈ÇƒÖd podczas zapisywania: ' + e.message, 'error');
            }
            
            log('');
            log('=== KONIEC MIGRACJI ===', 'info');
        }

        function clearAndReload() {
            if (!confirm('‚ö†Ô∏è To usunie wszystkie dane CMS i przywr√≥ci domy≈õlne. Czy na pewno?')) {
                return;
            }
            
            clearLog();
            log('=== CZYSZCZENIE DANYCH ===', 'warning');
            log('');
            
            try {
                localStorage.removeItem('estalaraAdminData');
                log('‚úÖ Dane usuniƒôte z localStorage', 'success');
                log('');
                log('üîÑ Prze≈Çadowujƒô stronƒô za 2 sekundy...', 'info');
                
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } catch (e) {
                log('‚ùå B≈ÇƒÖd podczas czyszczenia: ' + e.message, 'error');
            }
        }
    </script>
</body>
</html>
