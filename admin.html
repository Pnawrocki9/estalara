<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estalara Admin - Content Management</title>
    <link rel="icon" type="image/png" href="assets/EstalaraLogo.png">
    <!-- TODO: For production, replace Tailwind CDN with built CSS using Tailwind CLI -->
    <!-- Install: npm install -D tailwindcss postcss autoprefixer -->
    <!-- See: https://tailwindcss.com/docs/installation -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load CMS integration to access admin data -->
    <script src="cms-integration.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .admin-nav { background: #000000; }
        .admin-sidebar { background: #111827; }
        .admin-content { background: #f9fafb; }
        .admin-card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .admin-input { border: 1px solid #d1d5db; border-radius: 6px; padding: 8px 12px; }
        .admin-btn { padding: 8px 16px; border-radius: 6px; font-weight: 500; cursor: pointer; }
        .admin-btn-primary { background: #000000; color: white; border: 2px solid #000000; }
        .admin-btn-primary:hover { background: #ffffff; color: #000000; }
        .admin-btn-secondary { background: #6b7280; color: white; }
        .admin-btn-success { background: #10b981; color: white; }
        .admin-btn-danger { background: #ef4444; color: white; }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th, .admin-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; }
        .admin-table th { background: #f9fafb; font-weight: 600; }
        .admin-badge { padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .admin-badge-live { background: #dcfce7; color: #166534; }
        .admin-badge-draft { background: #fef3c7; color: #92400e; }
        .logo-preview { max-height: 60px; margin-top: 10px; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px; background: #f9fafb; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="admin-nav text-white p-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <h1 class="text-xl font-bold">Estalara Admin</h1>
                <span class="text-sm text-gray-300">Content Management</span>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm">Welcome, Admin</span>
                <button class="admin-btn admin-btn-secondary" onclick="logout()">Logout</button>
            </div>
        </div>
    </nav>

    <div class="flex">
        <!-- Sidebar -->
        <div class="admin-sidebar text-white w-64 min-h-screen p-4">
            <nav class="space-y-2">
                <a href="#" class="block p-3 rounded hover:bg-gray-700" onclick="showSection('dashboard')">
                    üìä Dashboard
                </a>
                <a href="#" class="block p-3 rounded hover:bg-gray-700" onclick="showSection('properties')">
                    üè† Properties
                </a>
                <a href="#" class="block p-3 rounded hover:bg-gray-700" onclick="showSection('pages')">
                    üìÑ Content Editor
                </a>
                <a href="#" class="block p-3 rounded hover:bg-gray-700" onclick="showSection('page-structure')">
                    üß© Page Structure
                </a>
                <a href="#" class="block p-3 rounded hover:bg-gray-700" onclick="showSection('settings')">
                    ‚öôÔ∏è Settings
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 admin-content p-6">
            <!-- Dashboard Section -->
            <div id="dashboard" class="section">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Dashboard</h2>
                    <p class="text-gray-600">Manage your Estalara website content from here.</p>
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="admin-card p-6 text-center">
                        <div class="text-3xl mb-4">üè†</div>
                        <h3 class="font-semibold mb-2">Manage Properties</h3>
                        <p class="text-gray-600 text-sm mb-4">Add, edit, or remove property listings</p>
                        <button class="admin-btn admin-btn-primary" onclick="showSection('properties')">Manage Properties</button>
                    </div>
                    <div class="admin-card p-6 text-center">
                        <div class="text-3xl mb-4">üìù</div>
                        <h3 class="font-semibold mb-2">Edit Content</h3>
                        <p class="text-gray-600 text-sm mb-4">Update website text and descriptions</p>
                        <button class="admin-btn admin-btn-primary" onclick="showSection('content')">Edit Content</button>
                    </div>
                    <div class="admin-card p-6 text-center">
                        <div class="text-3xl mb-4">‚öôÔ∏è</div>
                        <h3 class="font-semibold mb-2">Site Settings</h3>
                        <p class="text-gray-600 text-sm mb-4">Configure website settings</p>
                        <button class="admin-btn admin-btn-primary" onclick="showSection('settings')">Site Settings</button>
                    </div>
                </div>

                <!-- Current Status -->
                <div class="admin-card p-6">
                    <h3 class="text-lg font-semibold mb-4">Current Status</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600" id="propertyCount">6</div>
                            <div class="text-gray-600 text-sm">Active Properties</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="contentSections">4</div>
                            <div class="text-gray-600 text-sm">Content Sections</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-purple-600">‚Ç¨6.37M</div>
                            <div class="text-gray-600 text-sm">Total Value</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-orange-600">Live</div>
                            <div class="text-gray-600 text-sm">Site Status</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Properties Section -->
            <div id="properties" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Properties</h2>
                        <p class="text-gray-600">Manage your property listings that appear on the website.</p>
                    </div>
                    <button class="admin-btn admin-btn-primary" onclick="showPropertyModal()">+ Add Property</button>
                </div>

                <!-- Properties Table -->
                <div class="admin-card overflow-hidden">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Property</th>
                                <th>Location</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="propertiesTable">
                            <!-- Properties will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Content Section -->
            <div id="content" class="section hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Content Management</h2>
                    <p class="text-gray-600">Edit website content and text.</p>
                </div>

                <div class="space-y-6">
                    <!-- Hero Content -->
                    <div class="admin-card p-6">
                        <h3 class="text-lg font-semibold mb-4">Hero Section</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hero Title</label>
                                <input type="text" id="heroTitle" class="admin-input w-full" value="Go LIVE. Go GLOBAL.">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Hero Subtitle</label>
                                <textarea id="heroSubtitle" class="admin-input w-full" rows="4">Estalara connects real estate agents and global investors through AI and live experiences. Go LIVE. Go GLOBAL. Close deals faster than ever before.</textarea>
                            </div>
                            <button class="admin-btn admin-btn-primary" onclick="updateHeroContent()">Update Hero Content</button>
                        </div>
                    </div>

                    <!-- Site Info -->
                    <div class="admin-card p-6">
                        <h3 class="text-lg font-semibold mb-4">Site Information</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Site Title</label>
                                <input type="text" id="siteTitle" class="admin-input w-full" value="Estalara - Go LIVE. Go GLOBAL.">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Site Description</label>
                                <textarea id="siteDescription" class="admin-input w-full" rows="3">Estalara connects real estate agents and international investors through AI and live experiences. Simplify global property transactions with confidence.</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contact Email</label>
                                <input type="email" id="contactEmail" class="admin-input w-full" value="estalara@estalara.com">
                            </div>
                            <button class="admin-btn admin-btn-primary" onclick="updateSiteInfo()">Update Site Info</button>
                        </div>

                    <!-- Page Specific Content -->
                    <div class="admin-card p-6">
                        <h3 class="text-lg font-semibold mb-4">Page Specific Content</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Select Page</label>
                                <select id="pageSelect" class="admin-input w-full">
                                    <option value="agencies">Agencies</option>
                                    <option value="investors">Investors</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Section 1 Title</label>
                                <input type="text" id="section1Title" class="admin-input w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Section 1 Content</label>
                                <textarea id="section1Content" class="admin-input w-full" rows="3"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Section 1 Icon (emoji or class)</label>
                                <input type="text" id="section1Icon" class="admin-input w-full" placeholder="e.g. üé• or fa-video">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Section 1 Image URL</label>
                                <input type="text" id="section1Image" class="admin-input w-full" placeholder="https://example.com/image.jpg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Section 2 Title</label>
                                <input type="text" id="section2Title" class="admin-input w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Section 2 Content</label>
                                <textarea id="section2Content" class="admin-input w-full" rows="3"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Section 2 Icon</label>
                                <input type="text" id="section2Icon" class="admin-input w-full" placeholder="e.g. üì±">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Section 2 Image URL</label>
                                <input type="text" id="section2Image" class="admin-input w-full" placeholder="https://example.com/image.jpg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Section 3 Title</label>
                                <input type="text" id="section3Title" class="admin-input w-full">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Section 3 Content</label>
                                <textarea id="section3Content" class="admin-input w-full" rows="3"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Section 3 Icon</label>
                                <input type="text" id="section3Icon" class="admin-input w-full" placeholder="e.g. üöÄ">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Section 3 Image URL</label>
                                <input type="text" id="section3Image" class="admin-input w-full" placeholder="https://example.com/image.jpg">
                            </div>
                            <button class="admin-btn admin-btn-primary" onclick="updatePageSections()">Update Page Content</button>
                        </div>
                    </div>

                    <!-- Footer Editing -->
                    <div class="admin-card p-6">
                        <h3 class="text-lg font-semibold mb-4">Footer</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Footer Text</label>
                                <input type="text" id="footerText" class="admin-input w-full" value="">
                            </div>
                            <button class="admin-btn admin-btn-primary" onclick="updateFooterText()">Update Footer</button>
                        </div>
                    </div>
                    </div>
                </div>
            </div>

            <!-- Pages/Content Editor Section -->
            <div id="pages" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Content Editor</h2>
                        <p class="text-gray-600">Edit text content for all pages</p>
                    </div>
                </div>

                <!-- Info Card -->
                <div class="admin-card p-6 mb-6 bg-blue-50 border border-blue-200">
                    <h3 class="font-semibold text-blue-900 mb-2">‚ú® Full Content Control</h3>
                    <p class="text-blue-800 text-sm">
                        You can now edit all text content from your website directly in the CMS. 
                        Click "Edit Content" on any page below to modify hero sections, descriptions, and all other text elements.
                        Changes are saved to localStorage and will appear immediately on page refresh.
                    </p>
                </div>

                <!-- Pages Table -->
                <div class="admin-card overflow-hidden">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Page</th>
                                <th>URL</th>
                                <th>Editable Sections</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <div>
                                        <div class="font-medium">Home</div>
                                        <div class="text-sm text-gray-500">Main landing page</div>
                                    </div>
                                </td>
                                <td>/index.html</td>
                                <td>
                                    <div class="text-sm text-gray-600">
                                        Hero, How It Works, Features, CTA
                                    </div>
                                </td>
                                <td>
                                    <button class="admin-btn admin-btn-primary text-sm mr-2" onclick="editPage('home')">Edit Content</button>
                                    <button class="admin-btn admin-btn-success text-sm" onclick="previewPage('index')">Preview</button>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div>
                                        <div class="font-medium">For Agents</div>
                                        <div class="text-sm text-gray-500">Agent-focused content</div>
                                    </div>
                                </td>
                                <td>/agents.html</td>
                                <td>
                                    <div class="text-sm text-gray-600">
                                        Hero Section, All Text Content
                                    </div>
                                </td>
                                <td>
                                    <button class="admin-btn admin-btn-primary text-sm mr-2" onclick="editPage('agents')">Edit Content</button>
                                    <button class="admin-btn admin-btn-success text-sm" onclick="previewPage('agents')">Preview</button>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div>
                                        <div class="font-medium">For Investors</div>
                                        <div class="text-sm text-gray-500">Investor-focused content</div>
                                    </div>
                                </td>
                                <td>/investors.html</td>
                                <td>
                                    <div class="text-sm text-gray-600">
                                        Hero, 3 Content Sections
                                    </div>
                                </td>
                                <td>
                                    <button class="admin-btn admin-btn-primary text-sm mr-2" onclick="editPage('investors')">Edit Content</button>
                                    <button class="admin-btn admin-btn-success text-sm" onclick="previewPage('investors')">Preview</button>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div>
                                        <div class="font-medium">For Agencies</div>
                                        <div class="text-sm text-gray-500">Agency-focused content</div>
                                    </div>
                                </td>
                                <td>/agencies.html</td>
                                <td>
                                    <div class="text-sm text-gray-600">
                                        Hero, 3 Sections, White Label
                                    </div>
                                </td>
                                <td>
                                    <button class="admin-btn admin-btn-primary text-sm mr-2" onclick="editPage('agencies')">Edit Content</button>
                                    <button class="admin-btn admin-btn-success text-sm" onclick="previewPage('agencies')">Preview</button>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <div>
                                        <div class="font-medium">About</div>
                                        <div class="text-sm text-gray-500">Company information</div>
                                    </div>
                                </td>
                                <td>/about.html</td>
                                <td>
                                    <div class="text-sm text-gray-600">
                                        Hero Section, All Text Content
                                    </div>
                                </td>
                                <td>
                                    <button class="admin-btn admin-btn-primary text-sm mr-2" onclick="editPage('about')">Edit Content</button>
                                    <button class="admin-btn admin-btn-success text-sm" onclick="previewPage('about')">Preview</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Page Structure Section -->
            <div id="page-structure" class="section hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Page Structure Editor</h2>
                        <p class="text-gray-600">Manage sections and blocks for each page - add, delete, hide, or reorder</p>
                    </div>
                </div>

                <!-- Page Selector -->
                <div class="admin-card p-6 mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Select Page to Edit</label>
                    <select id="page-selector" class="admin-input w-full md:w-1/2" onchange="loadPageStructureEditor()">
                        <option value="home">Home</option>
                        <option value="agents">For Agents</option>
                        <option value="agencies">For Agencies</option>
                        <option value="investors">For Investors</option>
                        <option value="about">About</option>
                    </select>
                </div>

                <!-- Structure Visualization -->
                <div class="admin-card p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Page Structure</h3>
                        <button class="admin-btn admin-btn-primary" onclick="showAddSectionModal()">+ Add Section</button>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded mb-4">
                        <p class="text-sm text-gray-600 mb-2">
                            <strong>Visual Guide:</strong>
                        </p>
                        <ul class="text-sm text-gray-600 space-y-1">
                            <li>‚Ä¢ üëÅÔ∏è Visible section (shown on the page)</li>
                            <li>‚Ä¢ üö´ Hidden section (not displayed on the page)</li>
                            <li>‚Ä¢ üîí Locked section (cannot be deleted)</li>
                            <li>‚Ä¢ Use ‚Üë‚Üì buttons to reorder sections</li>
                        </ul>
                    </div>

                    <div id="sections-list" class="space-y-3">
                        <!-- Sections will be dynamically loaded here -->
                    </div>
                </div>

                <!-- Preview -->
                <div class="admin-card p-6">
                    <h3 class="text-lg font-semibold mb-4">Quick Actions</h3>
                    <div class="flex gap-3">
                        <button class="admin-btn admin-btn-success" onclick="previewCurrentPage()">
                            üëÅÔ∏è Preview Page
                        </button>
                        <button class="admin-btn admin-btn-secondary" onclick="resetPageStructure()">
                            üîÑ Reset to Default
                        </button>
                    </div>
                </div>
            </div>

            <!-- Settings Section -->
            <div id="settings" class="section hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Settings</h2>
                    <p class="text-gray-600">Configure your website settings.</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- General Settings -->
                    <div class="admin-card p-6">
                        <h3 class="text-lg font-semibold mb-4">General Settings</h3>
                        <form id="general-settings-form" class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Site Title</label>
                                <input type="text" id="site-title" name="siteTitle" class="admin-input w-full" value="Estalara - Go LIVE. Go GLOBAL.">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Site Description</label>
                                <textarea id="site-description" name="siteDescription" class="admin-input w-full" rows="3">Estalara connects real estate agents and international investors through AI and live experiences.</textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contact Email</label>
                                <input type="email" id="contact-email" name="contactEmail" class="admin-input w-full" value="estalara@estalara.com">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Logo</label>
                                <div class="space-y-3">
                                    <div class="bg-blue-50 border border-blue-200 p-3 rounded mb-3">
                                        <p class="text-sm text-blue-900 font-semibold mb-1">üõà For Netlify deployment:</p>
                                        <ul class="text-xs text-blue-800 space-y-1">
                                            <li>‚Ä¢ <strong>Recommended:</strong> Use a URL path like <code class="bg-blue-100 px-1 rounded">assets/EstalaraLogo.png</code></li>
                                            <li>‚Ä¢ Make sure the logo file exists in your <code class="bg-blue-100 px-1 rounded">assets/</code> folder</li>
                                            <li>‚Ä¢ File upload creates a data URL (works but increases localStorage size)</li>
                                        </ul>
                                    </div>
                                    <div>
                                        <label for="logo-upload" class="admin-btn admin-btn-primary cursor-pointer inline-block">
                                            üìÅ Choose Logo File
                                        </label>
                                        <input type="file" id="logo-upload" name="logoUpload" accept="image/*" class="hidden">
                                        <p class="text-xs text-gray-500 mt-2">Upload your logo (converts to data URL, stored in browser)</p>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        <strong>OR</strong> enter a URL:
                                    </div>
                                    <input type="text" id="logo-url" name="logoUrl" class="admin-input w-full" placeholder="assets/EstalaraLogo.png" value="assets/logo.svg">
                                    <p class="text-xs text-gray-500">Use a path relative to your website root (e.g., assets/logo.png) or full URL</p>
                                </div>
                                <div id="logo-preview-container" class="mt-4" style="display: none;">
                                    <p class="text-sm font-medium text-gray-700 mb-2">Current Logo:</p>
                                    <img id="logo-preview" class="logo-preview" alt="Logo Preview">
                                </div>
                            </div>
                            <button type="submit" class="admin-btn admin-btn-primary">Save Changes</button>
                        </form>
                    </div>

                    <!-- Platform Settings -->
                    <div class="admin-card p-6">
                        <h3 class="text-lg font-semibold mb-4">Platform Settings</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Default Currency</label>
                                <select id="default-currency" class="admin-input w-full">
                                    <option value="EUR">EUR (‚Ç¨)</option>
                                    <option value="USD">USD ($)</option>
                                    <option value="GBP">GBP (¬£)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Default Language</label>
                                <select id="default-language" class="admin-input w-full">
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Max Upload Size</label>
                                <input type="text" id="max-upload-size" class="admin-input w-full" value="10MB">
                            </div>
                        </div>
                        <button class="admin-btn admin-btn-primary mt-4" onclick="savePlatformSettings()">Save Changes</button>
                    </div>
                </div>

                <!-- Data Management -->
                <div class="grid grid-cols-1 gap-6 mt-6">
                    <div class="admin-card p-6">
                        <h3 class="text-lg font-semibold mb-4">Data Management</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Export Data</label>
                                <button class="admin-btn admin-btn-secondary w-full" onclick="exportData()">Export All Data</button>
                                <p class="text-xs text-gray-500 mt-1">Download all your content as JSON</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Import Data</label>
                                <input type="file" id="importFile" accept=".json" class="admin-input w-full mb-2">
                                <button class="admin-btn admin-btn-secondary w-full" onclick="importData()">Import Data</button>
                                <p class="text-xs text-gray-500 mt-1">Upload a JSON file with your content</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Section Modal (Page Structure Editor) -->
    <div id="addSectionModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-xl max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Add New Section</h3>
                <button onclick="hideAddSectionModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <form id="addSectionForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Section ID</label>
                    <input type="text" name="sectionId" class="admin-input w-full" placeholder="e.g., custom-features" required>
                    <p class="text-xs text-gray-500 mt-1">Unique identifier (lowercase, no spaces, use hyphens)</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Section Title</label>
                    <input type="text" name="sectionTitle" class="admin-input w-full" placeholder="e.g., Custom Features" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Section Type</label>
                    <select name="sectionType" class="admin-input w-full">
                        <option value="section">Section</option>
                        <option value="hero">Hero</option>
                        <option value="cta">CTA</option>
                        <option value="stats">Stats</option>
                    </select>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 p-3 rounded">
                    <p class="text-sm text-yellow-800">
                        <strong>Note:</strong> After adding a new section, you'll need to manually add the corresponding HTML to your page file with the matching ID.
                    </p>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="hideAddSectionModal()" class="admin-btn admin-btn-secondary">Cancel</button>
                    <button type="submit" class="admin-btn admin-btn-primary">Add Section</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Page Editor Modal (Content Editor) -->
    <div id="pageEditorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold" id="pageEditorTitle">Edit Page</h3>
                <button onclick="hidePageEditor()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <div id="pageEditorContent">
                <!-- Page editor content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Property Modal -->
    <div id="propertyModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-screen overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="propertyModalTitle" class="text-lg font-semibold">Add New Property</h3>
                <button onclick="hidePropertyModal()" class="text-gray-500 hover:text-gray-700">‚úï</button>
            </div>
            <form id="propertyForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Property Title</label>
                        <input type="text" name="title" class="admin-input w-full" placeholder="e.g., Modern Apartment in Barcelona" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                        <input type="text" name="location" class="admin-input w-full" placeholder="e.g., Barcelona, Spain" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Price (‚Ç¨)</label>
                        <input type="number" name="price" class="admin-input w-full" placeholder="450000" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Property Type</label>
                        <select name="type" class="admin-input w-full" required>
                            <option value="">Select Type</option>
                            <option value="apartment">Apartment</option>
                            <option value="house">House</option>
                            <option value="villa">Villa</option>
                            <option value="penthouse">Penthouse</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                    <textarea name="description" class="admin-input w-full" rows="4" placeholder="Property description..." required></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Property Image URL</label>
                    <input type="url" name="image" class="admin-input w-full" placeholder="https://example.com/image.jpg" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Estalara App Link</label>
                    <input type="url" name="link" class="admin-input w-full" placeholder="https://app.estalara.com/listing/..." required>
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" onclick="hidePropertyModal()" class="admin-btn admin-btn-secondary">Cancel</button>
                    <button type="submit" class="admin-btn admin-btn-primary">Save Property</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Admin JavaScript functionality
        let adminData = {
            properties: [
                {
                    id: 1,
                    title: "Modern Apartment in C√°diz",
                    location: "C√°diz, Spain",
                    price: 450000,
                    image: "https://kimi-web-img.moonshot.cn/img/talatiandpartners.com/952038c4e2cdd1b53bd4fa58a12aa8472e239da8.webp",
                    description: "Stunning property in the heart of C√°diz with ocean views and modern amenities.",
                    link: "https://app.estalara.com/listing/-cadiz-cadiz-na-d19331b5-846d-4139-a78e-2d9695ff73d0",
                    status: "live"
                },
                {
                    id: 2,
                    title: "Luxury Penthouse in Madrid",
                    location: "Madrid, Spain",
                    price: 1200000,
                    image: "https://kimi-web-img.moonshot.cn/img/www.valcucine.com/23a9f04943354e7f0279fbe99bcc358000b108f4.jpg",
                    description: "Exclusive penthouse in Madrid's premium district with panoramic city views.",
                    link: "https://app.estalara.com/listing/-madrid-madrid-na-8a9b2c1d-4e5f-6a7b-8c9d-0e1f2a3b4c5d",
                    status: "live"
                },
                {
                    id: 3,
                    title: "Beachfront Villa in Barcelona",
                    location: "Barcelona, Spain",
                    price: 2800000,
                    image: "https://kimi-web-img.moonshot.cn/img/antonovich-design.com/c4dc761e62d99ae8976671614b35f23c72bda4df.jpg",
                    description: "Spectacular beachfront villa with private pool and direct beach access.",
                    link: "https://app.estalara.com/listing/-barcelona-barcelona-na-5f6e7d8c-9a0b-1c2d-3e4f-5a6b7c8d9e0f",
                    status: "live"
                },
                {
                    id: 4,
                    title: "Historic Building in Valencia",
                    location: "Valencia, Spain",
                    price: 750000,
                    image: "https://kimi-web-img.moonshot.cn/img/www.elegantinterior.info/c0b1fd32f4cdc3abdaccf6a5f411e8f3fb8e6e92.png",
                    description: "Beautifully restored historic building in Valencia's old town with modern interiors.",
                    link: "https://app.estalara.com/listing/-valencia-valencia-na-2a3b4c5d-6e7f-8a9b-0c1d-2e3f4a5b6c7d",
                    status: "live"
                },
                {
                    id: 5,
                    title: "Traditional House in Seville",
                    location: "Seville, Spain",
                    price: 320000,
                    image: "https://kimi-web-img.moonshot.cn/img/idea.3dbrute.com/eaa4c4cbb5ccbf57f4732305104dd9187d2276a4.jpg",
                    description: "Authentic Andalusian house with patio, perfect for cultural immersion.",
                    link: "https://app.estalara.com/listing/-seville-seville-na-9c8d7e6f-5a4b-3c2d-1e0f-9a8b7c6d5e4f",
                    status: "live"
                },
                {
                    id: 6,
                    title: "Modern Villa in Malaga",
                    location: "Malaga, Spain",
                    price: 1850000,
                    image: "https://kimi-web-img.moonshot.cn/img/archello.s3.eu-central-1.amazonaws.com/e68f5c11f478a0669779d5422a04c826a028dca0.jpg",
                    description: "Contemporary villa with stunning sea views and infinity pool in Costa del Sol.",
                    link: "https://app.estalara.com/listing/-malaga-malaga-na-7d6e5f4a-3b2c-1d0e-9f8a-7b6c5d4e3f2a",
                    status: "live"
                }
            ],
            content: {
                siteTitle: "Estalara - Go LIVE. Go GLOBAL.",
                siteDescription: "Estalara connects real estate agents and international investors through AI and live experiences. Simplify global property transactions with confidence.",
                contactEmail: "estalara@estalara.com",
                heroTitle: "Go LIVE. Go GLOBAL.",
                heroSubtitle: "Estalara connects real estate agents and global investors through AI and live experiences. Go LIVE. Go GLOBAL. Close deals faster than ever before.",
                currency: "EUR",
                language: "en",
                footerText: "¬© 2024 Estalara. All rights reserved.",
                pages: {
                    agencies: {},
                    investors: {}
                }
            }
        };

        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.remove('hidden');

            // Load section-specific content
            if (sectionId === 'properties') {
                loadProperties();
            } else if (sectionId === 'content') {
                loadContent();
            } else if (sectionId === 'settings') {
                loadSettings();
            }
        }

        function loadProperties() {
            const tbody = document.getElementById('propertiesTable');
            tbody.innerHTML = '';

            adminData.properties.forEach(property => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="flex items-center space-x-3">
                            <img src="${property.image}" alt="${property.title}" class="w-12 h-12 object-cover rounded">
                            <div>
                                <div class="font-medium">${property.title}</div>
                                <div class="text-sm text-gray-500">${property.type || 'Property'}</div>
                            </div>
                        </div>
                    </td>
                    <td>${property.location}</td>
                    <td>‚Ç¨${property.price.toLocaleString()}</td>
                    <td><span class="admin-badge admin-badge-${property.status}">${property.status.toUpperCase()}</span></td>
                    <td>
                        <button class="admin-btn admin-btn-secondary text-sm mr-2" onclick="editProperty(${property.id})">Edit</button>
                        <button class="admin-btn admin-btn-danger text-sm" onclick="deleteProperty(${property.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Update property count
            document.getElementById('propertyCount').textContent = adminData.properties.length;
        }

        function loadContent() {
            document.getElementById('heroTitle').value = adminData.content.heroTitle;
            document.getElementById('heroSubtitle').value = adminData.content.heroSubtitle;
            document.getElementById('siteTitle').value = adminData.content.siteTitle;
            document.getElementById('siteDescription').value = adminData.content.siteDescription;
            document.getElementById('contactEmail').value = adminData.content.contactEmail;
        }

        function loadSettings() {
            // Load general settings
            if (adminData.content.siteTitle) {
                document.getElementById('site-title').value = adminData.content.siteTitle;
            }
            if (adminData.content.siteDescription) {
                document.getElementById('site-description').value = adminData.content.siteDescription;
            }
            if (adminData.content.contactEmail) {
                document.getElementById('contact-email').value = adminData.content.contactEmail;
            }
            if (adminData.content.logoUrl) {
                document.getElementById('logo-url').value = adminData.content.logoUrl;
                updateLogoPreview(adminData.content.logoUrl);
            }
            
            // Load platform settings
            if (adminData.content.currency) {
                document.getElementById('default-currency').value = adminData.content.currency;
            }
            if (adminData.content.language) {
                document.getElementById('default-language').value = adminData.content.language;
            }
            if (adminData.content.maxUploadSize) {
                document.getElementById('max-upload-size').value = adminData.content.maxUploadSize;
            }
        }

        // Update logo preview
        function updateLogoPreview(url) {
            const previewContainer = document.getElementById('logo-preview-container');
            const previewImg = document.getElementById('logo-preview');
            
            if (!url || !url.trim()) {
                previewContainer.style.display = 'none';
                return;
            }
            
            // Show container immediately with loading state
            previewContainer.style.display = 'block';
            previewContainer.innerHTML = `
                <p class="text-sm font-medium text-gray-700 mb-2">Logo Preview:</p>
                <div class="logo-preview flex items-center justify-center">
                    <span class="text-gray-500">Loading preview...</span>
                </div>
                <p class="text-xs text-gray-500 mt-2">URL: <code class="bg-gray-100 px-1 rounded">${url.substring(0, 60)}${url.length > 60 ? '...' : ''}</code></p>
            `;
            
            // Encode the URL to handle spaces and special characters
            // But preserve data URLs (they start with 'data:')
            let encodedUrl = url;
            if (!url.startsWith('data:') && !url.startsWith('http://') && !url.startsWith('https://')) {
                // For relative paths, encode each component separately to preserve slashes
                const parts = url.split('/');
                encodedUrl = parts.map(part => encodeURIComponent(part)).join('/');
            }
            
            // Create a new image to test if it loads
            const testImg = new Image();
            
            testImg.onload = function() {
                // Image loaded successfully - show it
                previewContainer.innerHTML = `
                    <p class="text-sm font-medium text-gray-700 mb-2">Current Logo:</p>
                    <img id="logo-preview" class="logo-preview" src="${encodedUrl}" alt="Logo Preview">
                    <p class="text-xs text-green-600 mt-2">‚úì Logo loaded successfully</p>
                `;
            };
            
            testImg.onerror = function() {
                // Image failed to load - show helpful message
                const isRelativePath = !url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('data:');
                previewContainer.innerHTML = `
                    <p class="text-sm font-medium text-gray-700 mb-2">Logo Preview:</p>
                    <div class="logo-preview flex flex-col items-center justify-center bg-yellow-50 border-2 border-yellow-300">
                        <span class="text-yellow-700 text-3xl mb-2">‚ö†Ô∏è</span>
                        <span class="text-yellow-800 font-medium">Preview not available</span>
                        <span class="text-yellow-700 text-xs mt-1">${isRelativePath ? 'File will be loaded from your website' : 'Check if URL is valid'}</span>
                    </div>
                    <p class="text-xs text-gray-600 mt-2">URL saved: <code class="bg-gray-100 px-1 rounded">${url.substring(0, 50)}${url.length > 50 ? '...' : ''}</code></p>
                    <p class="text-xs text-blue-600 mt-1">üí° Click "Save Changes" to apply this logo to your website</p>
                `;
            };
            
            // Start loading the image
            testImg.src = encodedUrl;
        }

        // Save general settings
        function saveGeneralSettings() {
            const logoUrl = document.getElementById('logo-url').value;
            
            // Validate logo URL for Netlify deployment
            if (logoUrl && !logoUrl.startsWith('data:')) {
                if (logoUrl.includes(' ')) {
                    if (!confirm('Warning: Your logo URL contains spaces. This may cause issues on Netlify.\\n\\nRecommendation: Use a filename without spaces (e.g., \"assets/EstalaraLogo.png\").\\n\\nDo you want to save anyway?')) {
                        return;
                    }
                }
                
                // Show helpful tip for relative URLs
                if (logoUrl.startsWith('assets/') && !logoUrl.startsWith('data:')) {
                    showNotification('Good choice! Using a relative path ensures your logo persists on Netlify. ‚úì', 'success');
                }
            }
            
            adminData.content.siteTitle = document.getElementById('site-title').value;
            adminData.content.siteDescription = document.getElementById('site-description').value;
            adminData.content.contactEmail = document.getElementById('contact-email').value;
            adminData.content.logoUrl = logoUrl;
            
            saveData();
            showNotification('Settings saved successfully! Refresh your website pages to see changes.');
        }

        // Save platform settings
        function savePlatformSettings() {
            adminData.content.currency = document.getElementById('default-currency').value;
            adminData.content.language = document.getElementById('default-language').value;
            adminData.content.maxUploadSize = document.getElementById('max-upload-size').value;
            
            saveData();
            showNotification('Platform settings saved successfully!');
        }

        function showPropertyModal() {
            // Reset modal title to "Add New Property" when opening for new property
            document.getElementById('propertyModalTitle').textContent = 'Add New Property';
            document.getElementById('propertyModal').classList.remove('hidden');
            document.getElementById('propertyModal').classList.add('flex');
        }

        function hidePropertyModal() {
            const form = document.getElementById('propertyForm');
            // Clear editId before resetting to avoid any issues
            if (form.dataset.editId) {
                delete form.dataset.editId;
            }
            document.getElementById('propertyModal').classList.add('hidden');
            document.getElementById('propertyModal').classList.remove('flex');
            form.reset();
        }

        function editProperty(id) {
            const property = adminData.properties.find(p => p.id === id);
            if (property) {
                console.log('Editing property:', id, property);
                
                // Fill form with property data
                const form = document.getElementById('propertyForm');
                form.title.value = property.title || '';
                form.location.value = property.location || '';
                form.price.value = property.price || '';
                form.type.value = property.type || '';
                form.description.value = property.description || '';
                form.image.value = property.image || '';
                form.link.value = property.link || '';
                
                console.log('Form populated with link:', property.link);
                
                // Change form to edit mode
                form.dataset.editId = id;
                
                // Update modal title
                document.getElementById('propertyModalTitle').textContent = 'Edit Property';
                
                // Show modal
                document.getElementById('propertyModal').classList.remove('hidden');
                document.getElementById('propertyModal').classList.add('flex');
            } else {
                console.error('Property not found:', id);
                alert('Error: Property not found!');
            }
        }

        function deleteProperty(id) {
            if (confirm('Are you sure you want to delete this property?')) {
                adminData.properties = adminData.properties.filter(p => p.id !== id);
                saveData();
                loadProperties();
                alert('Property deleted successfully!');
            }
        }

        function updateHeroContent() {
            adminData.content.heroTitle = document.getElementById('heroTitle').value;
            adminData.content.heroSubtitle = document.getElementById('heroSubtitle').value;
            saveData();
            alert('Hero content updated successfully!');
        }

        function updateSiteInfo() {
            adminData.content.siteTitle = document.getElementById('siteTitle').value;
            adminData.content.siteDescription = document.getElementById('siteDescription').value;
            adminData.content.contactEmail = document.getElementById('contactEmail').value;
            saveData();
            alert('Site information updated successfully!');
        }

        // Legacy function - keeping for backwards compatibility
        function updateSettings() {
            savePlatformSettings();
        }

        // Load page-specific section fields based on selected page
        function loadPageSectionFields() {
            const select = document.getElementById('pageSelect');
            if (!select) return;
            
            // Ensure pages object exists
            if (!adminData.content.pages) {
                adminData.content.pages = {};
            }
            
            const pageKey = select.value;
            const page = adminData.content.pages[pageKey] || {};
            
            document.getElementById('section1Title').value = page.section1Title || '';
            document.getElementById('section1Content').value = page.section1Content || '';
            document.getElementById('section1Icon').value = page.section1Icon || '';
            document.getElementById('section1Image').value = page.section1Image || '';
            document.getElementById('section2Title').value = page.section2Title || '';
            document.getElementById('section2Content').value = page.section2Content || '';
            document.getElementById('section2Icon').value = page.section2Icon || '';
            document.getElementById('section2Image').value = page.section2Image || '';
            document.getElementById('section3Title').value = page.section3Title || '';
            document.getElementById('section3Content').value = page.section3Content || '';
            document.getElementById('section3Icon').value = page.section3Icon || '';
            document.getElementById('section3Image').value = page.section3Image || '';
        }
        // Update sections for selected page
        function updatePageSections() {
            const pageKey = document.getElementById('pageSelect').value;
            if (!adminData.content.pages) {
                adminData.content.pages = {};
            }
            if (!adminData.content.pages[pageKey]) {
                adminData.content.pages[pageKey] = {};
            }
            adminData.content.pages[pageKey].section1Title = document.getElementById('section1Title').value;
            adminData.content.pages[pageKey].section1Content = document.getElementById('section1Content').value;
            adminData.content.pages[pageKey].section1Icon = document.getElementById('section1Icon').value;
            adminData.content.pages[pageKey].section1Image = document.getElementById('section1Image').value;
            adminData.content.pages[pageKey].section2Title = document.getElementById('section2Title').value;
            adminData.content.pages[pageKey].section2Content = document.getElementById('section2Content').value;
            adminData.content.pages[pageKey].section2Icon = document.getElementById('section2Icon').value;
            adminData.content.pages[pageKey].section2Image = document.getElementById('section2Image').value;
            adminData.content.pages[pageKey].section3Title = document.getElementById('section3Title').value;
            adminData.content.pages[pageKey].section3Content = document.getElementById('section3Content').value;
            adminData.content.pages[pageKey].section3Icon = document.getElementById('section3Icon').value;
            adminData.content.pages[pageKey].section3Image = document.getElementById('section3Image').value;
            saveData();
            alert('Page content updated successfully!');
        }
        // Update footer text
        function updateFooterText() {
            adminData.content.footerText = document.getElementById('footerText').value;
            saveData();
            alert('Footer updated successfully!');
        }

        function exportData() {
            const dataStr = JSON.stringify(adminData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'estalara-content.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please select a JSON file to import.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (confirm('This will replace all your current data. Are you sure?')) {
                        adminData = importedData;
                        saveData();
                        alert('Data imported successfully! Please refresh the page.');
                    }
                } catch (error) {
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }

        function saveData() {
            localStorage.setItem('estalaraAdminData', JSON.stringify(adminData));
        }

        function loadData() {
            const stored = localStorage.getItem('estalaraAdminData');
            if (stored) {
                adminData = JSON.parse(stored);
                // Ensure critical structure exists to prevent errors
                if (!adminData.content) {
                    adminData.content = {};
                }
                if (!adminData.content.pages) {
                    adminData.content.pages = {};
                }
                if (!adminData.properties) {
                    adminData.properties = [];
                }
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = 'admin-login.html';
            }
        }

        // Property Form Handler
        document.getElementById('propertyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const propertyData = Object.fromEntries(formData);
            propertyData.price = parseInt(propertyData.price);
            
            // Convert editId to number for proper comparison
            const editIdStr = e.target.dataset.editId;
            const editId = editIdStr ? parseInt(editIdStr) : null;
            
            console.log('Saving property:', {editId, propertyData});
            
            if (editId) {
                // Update existing property
                const index = adminData.properties.findIndex(p => p.id === editId);
                if (index !== -1) {
                    // Preserve existing fields and update with new data
                    const updatedProperty = { ...adminData.properties[index], ...propertyData };
                    adminData.properties[index] = updatedProperty;
                    console.log('Updated property:', updatedProperty);
                } else {
                    console.error('Property not found:', editId);
                    alert('Error: Property not found!');
                    return;
                }
                delete e.target.dataset.editId;
            } else {
                // Add new property
                propertyData.id = Date.now();
                propertyData.status = 'live';
                adminData.properties.push(propertyData);
                console.log('Added new property:', propertyData);
            }
            
            // Save to localStorage
            saveData();
            
            // Reload properties list to reflect changes
            loadProperties();
            
            // Hide modal and show success
            hidePropertyModal();
            alert('Property saved successfully!');
        });

        // ===== CONTENT EDITOR FUNCTIONS =====
        
        function editPage(pageId) {
            loadPageEditor(pageId);
        }

        function previewPage(pageId) {
            window.open(`/${pageId}.html`, '_blank');
        }

        function loadAdminData() {
            const stored = localStorage.getItem('estalaraAdminData');
            if (stored) {
                const data = JSON.parse(stored);
                // Ensure structure is consistent
                if (!data.content) {
                    data.content = {};
                }
                if (!data.content.pages) {
                    data.content.pages = {};
                }
                return data;
            }
            return { content: { pages: {} }, properties: [] };
        }

        // Load page editor
        function loadPageEditor(pageId) {
            const admin = loadAdminData();
            const page = (admin.content && admin.content.pages && admin.content.pages[pageId]) || {};
            
            document.getElementById('pageEditorTitle').textContent = `Edit ${pageId.charAt(0).toUpperCase() + pageId.slice(1)} Page`;
            
            let editorHtml = `<form id="pageEditorForm" class="space-y-4">`;
            
            // Hero Section
            editorHtml += `<div class="border-b pb-4 mb-4">
                <h4 class="font-semibold text-lg mb-3">Hero Section</h4>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Hero Title</label>
                    <input type="text" name="heroTitle" class="admin-input w-full" value="${page.heroTitle || ''}" placeholder="Main headline">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Hero Subtitle</label>
                    <textarea name="heroSubtitle" class="admin-input w-full" rows="3" placeholder="Subtitle text">${page.heroSubtitle || ''}</textarea>
                </div>
            </div>`;
            
            // For home page - additional sections
            if (pageId === 'home') {
                editorHtml += `<div class="border-b pb-4 mb-4">
                    <h4 class="font-semibold text-lg mb-3">How It Works Section</h4>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                        <input type="text" name="howItWorksTitle" class="admin-input w-full" value="${page.howItWorksTitle || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Subtitle</label>
                        <textarea name="howItWorksSubtitle" class="admin-input w-full" rows="2">${page.howItWorksSubtitle || ''}</textarea>
                    </div>
                </div>`;
                
                editorHtml += `<div class="border-b pb-4 mb-4">
                    <h4 class="font-semibold text-lg mb-3">Features Section</h4>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                        <input type="text" name="featuresTitle" class="admin-input w-full" value="${page.featuresTitle || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Subtitle</label>
                        <textarea name="featuresSubtitle" class="admin-input w-full" rows="2">${page.featuresSubtitle || ''}</textarea>
                    </div>
                </div>`;
                
                editorHtml += `<div class="border-b pb-4 mb-4">
                    <h4 class="font-semibold text-lg mb-3">CTA Section</h4>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                        <input type="text" name="ctaTitle" class="admin-input w-full" value="${page.ctaTitle || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Subtitle</label>
                        <textarea name="ctaSubtitle" class="admin-input w-full" rows="2">${page.ctaSubtitle || ''}</textarea>
                    </div>
                </div>`;
            }
            
            // For investors and agencies pages - content sections
            if (pageId === 'investors' || pageId === 'agencies') {
                for (let i = 1; i <= 3; i++) {
                    editorHtml += `<div class="border-b pb-4 mb-4">
                        <h4 class="font-semibold text-lg mb-3">Content Section ${i}</h4>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Icon (emoji)</label>
                            <input type="text" name="section${i}Icon" class="admin-input w-full" value="${page['section' + i + 'Icon'] || ''}" placeholder="üåç">
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                            <input type="text" name="section${i}Title" class="admin-input w-full" value="${page['section' + i + 'Title'] || ''}">
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Content</label>
                            <textarea name="section${i}Content" class="admin-input w-full" rows="4">${page['section' + i + 'Content'] || ''}</textarea>
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Image URL</label>
                            <input type="text" name="section${i}Image" class="admin-input w-full" value="${page['section' + i + 'Image'] || ''}" placeholder="https://example.com/image.jpg">
                        </div>
                    </div>`;
                }
            }
            
            // For agencies page - white label section
            if (pageId === 'agencies') {
                editorHtml += `<div class="border-b pb-4 mb-4">
                    <h4 class="font-semibold text-lg mb-3">White Label Section</h4>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                        <input type="text" name="whiteLabelTitle" class="admin-input w-full" value="${page.whiteLabelTitle || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Subtitle</label>
                        <textarea name="whiteLabelSubtitle" class="admin-input w-full" rows="3">${page.whiteLabelSubtitle || ''}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Benefits Title</label>
                        <input type="text" name="whiteLabelBenefitsTitle" class="admin-input w-full" value="${page.whiteLabelBenefitsTitle || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Benefits List (one per line)</label>
                        <textarea name="whiteLabelBenefitsList" class="admin-input w-full" rows="4" placeholder="Your own branding\nBranded livestreams\n...">${(page.whiteLabelBenefitsList || []).join('\n')}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Why Title</label>
                        <input type="text" name="whiteLabelWhyTitle" class="admin-input w-full" value="${page.whiteLabelWhyTitle || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Why List (one per line)</label>
                        <textarea name="whiteLabelWhyList" class="admin-input w-full" rows="4" placeholder="Greater customer trust\nFaster implementations\n...">${(page.whiteLabelWhyList || []).join('\n')}</textarea>
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Label</label>
                        <input type="text" name="whiteLabelContactLabel" class="admin-input w-full" value="${page.whiteLabelContactLabel || ''}">
                    </div>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Contact Email</label>
                        <input type="email" name="whiteLabelContactEmail" class="admin-input w-full" value="${page.whiteLabelContactEmail || ''}">
                    </div>
                </div>`;
            }
            
            editorHtml += `<div class="flex justify-end space-x-3 pt-4">
                <button type="button" onclick="hidePageEditor()" class="admin-btn admin-btn-secondary">Cancel</button>
                <button type="submit" class="admin-btn admin-btn-primary">Save Changes</button>
            </div></form>`;
            
            document.getElementById('pageEditorContent').innerHTML = editorHtml;
            
            // Attach form handler
            document.getElementById('pageEditorForm').addEventListener('submit', function(e) {
                e.preventDefault();
                savePageContent(pageId, new FormData(e.target));
            });
            
            // Show modal
            document.getElementById('pageEditorModal').classList.remove('hidden');
            document.getElementById('pageEditorModal').classList.add('flex');
        }
        
        function hidePageEditor() {
            document.getElementById('pageEditorModal').classList.add('hidden');
            document.getElementById('pageEditorModal').classList.remove('flex');
        }
        
        function savePageContent(pageId, formData) {
            const admin = loadAdminData();
            
            if (!admin.content.pages[pageId]) {
                admin.content.pages[pageId] = {};
            }
            
            // Convert form data to object
            const updates = {};
            for (let [key, value] of formData.entries()) {
                // Handle list fields
                if (key.includes('List')) {
                    updates[key] = value.split('\n').filter(item => item.trim());
                } else {
                    updates[key] = value;
                }
            }
            
            // Update page content
            admin.content.pages[pageId] = { ...admin.content.pages[pageId], ...updates };
            
            // Save to localStorage
            localStorage.setItem('estalaraAdminData', JSON.stringify(admin));
            
            // Show success message
            alert('Page content updated successfully! Refresh the frontend page to see changes.');
            hidePageEditor();
        }

        // ===== PAGE STRUCTURE EDITOR FUNCTIONS =====
        
        let currentPageId = 'home';

        // Load page structure editor
        function loadPageStructureEditor() {
            currentPageId = document.getElementById('page-selector').value;
            renderPageStructure();
        }

        // Render page structure
        function renderPageStructure() {
            const admin = window.estalaraAdmin;
            if (!admin) {
                console.error('EstalaraAdmin not available yet. Will retry...');
                setTimeout(renderPageStructure, 100);
                return;
            }

            const structure = admin.getPageStructure(currentPageId);
            const container = document.getElementById('sections-list');
            
            if (structure.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-8">No sections found for this page.</p>';
                return;
            }

            container.innerHTML = structure.map((section, index) => `
                <div class="bg-white border-2 ${section.visible ? 'border-green-200' : 'border-gray-300'} rounded-lg p-4 hover:shadow-md transition-shadow" data-section-id="${section.id}">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3 flex-1">
                            <div class="text-2xl">
                                ${section.visible ? 'üëÅÔ∏è' : 'üö´'}
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <h4 class="font-semibold text-gray-900">${section.title}</h4>
                                    ${!section.editable ? '<span class="text-xs bg-gray-200 px-2 py-1 rounded">üîí Locked</span>' : ''}
                                </div>
                                <p class="text-sm text-gray-500">ID: ${section.id} | Type: ${section.type}</p>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <!-- Reorder buttons -->
                            <button 
                                onclick="moveSection('${currentPageId}', '${section.id}', 'up')" 
                                class="admin-btn admin-btn-secondary text-xs px-2 py-1"
                                ${index === 0 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                ‚Üë
                            </button>
                            <button 
                                onclick="moveSection('${currentPageId}', '${section.id}', 'down')" 
                                class="admin-btn admin-btn-secondary text-xs px-2 py-1"
                                ${index === structure.length - 1 ? 'disabled style="opacity: 0.5; cursor: not-allowed;"' : ''}>
                                ‚Üì
                            </button>
                            <!-- Toggle visibility -->
                            <button 
                                onclick="toggleSectionVisibility('${currentPageId}', '${section.id}')" 
                                class="admin-btn ${section.visible ? 'admin-btn-secondary' : 'admin-btn-success'} text-xs">
                                ${section.visible ? 'Hide' : 'Show'}
                            </button>
                            <!-- Delete button (only for editable sections) -->
                            ${section.editable ? `
                                <button 
                                    onclick="deleteSection('${currentPageId}', '${section.id}')" 
                                    class="admin-btn admin-btn-danger text-xs">
                                    Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Toggle section visibility
        function toggleSectionVisibility(pageId, sectionId) {
            const admin = window.estalaraAdmin;
            if (!admin) return;

            admin.toggleSectionVisibility(pageId, sectionId);
            renderPageStructure();
            showNotification('Section visibility toggled successfully!');
        }

        // Move section up or down
        function moveSection(pageId, sectionId, direction) {
            const admin = window.estalaraAdmin;
            if (!admin) return;

            const structure = admin.getPageStructure(pageId);
            const index = structure.findIndex(s => s.id === sectionId);
            
            if (index === -1) return;
            
            if (direction === 'up' && index > 0) {
                [structure[index], structure[index - 1]] = [structure[index - 1], structure[index]];
            } else if (direction === 'down' && index < structure.length - 1) {
                [structure[index], structure[index + 1]] = [structure[index + 1], structure[index]];
            } else {
                return; // Can't move
            }

            // Update order property
            structure.forEach((s, i) => {
                s.order = i + 1;
            });

            admin.updatePageStructure(pageId, structure);
            renderPageStructure();
            showNotification('Section moved successfully!');
        }

        // Delete section
        function deleteSection(pageId, sectionId) {
            if (!confirm('Are you sure you want to delete this section? This action cannot be undone.')) {
                return;
            }

            const admin = window.estalaraAdmin;
            if (!admin) return;

            admin.removeSection(pageId, sectionId);
            renderPageStructure();
            showNotification('Section deleted successfully!');
        }

        // Show add section modal
        function showAddSectionModal() {
            document.getElementById('addSectionModal').classList.remove('hidden');
            document.getElementById('addSectionModal').classList.add('flex');
        }

        // Hide add section modal
        function hideAddSectionModal() {
            document.getElementById('addSectionModal').classList.add('hidden');
            document.getElementById('addSectionModal').classList.remove('flex');
            document.getElementById('addSectionForm').reset();
        }

        // Preview current page
        function previewCurrentPage() {
            const pageFiles = {
                'home': 'index.html',
                'agents': 'agents.html',
                'agencies': 'agencies.html',
                'investors': 'investors.html',
                'about': 'about.html'
            };
            
            const file = pageFiles[currentPageId] || 'index.html';
            window.open(file, '_blank');
        }

        // Reset page structure to default
        function resetPageStructure() {
            if (!confirm('Are you sure you want to reset this page structure to default? This will remove all customizations.')) {
                return;
            }

            const admin = window.estalaraAdmin;
            if (!admin) return;

            // Get default structure from cms-integration.js
            const defaultStructures = {
                home: [
                    { id: 'hero', type: 'hero', title: 'Hero Section', visible: true, order: 1, editable: false },
                    { id: 'how-it-works', type: 'section', title: 'How It Works', visible: true, order: 2, editable: true },
                    { id: 'live-properties', type: 'section', title: 'LIVE Properties', visible: true, order: 3, editable: false },
                    { id: 'features', type: 'section', title: 'Features', visible: true, order: 4, editable: true },
                    { id: 'cta', type: 'section', title: 'CTA Section', visible: true, order: 5, editable: true }
                ],
                agents: [
                    { id: 'hero', type: 'hero', title: 'Hero Section', visible: true, order: 1, editable: false },
                    { id: 'stats', type: 'section', title: 'Stats Section', visible: true, order: 2, editable: true },
                    { id: 'features', type: 'section', title: 'Features Section', visible: true, order: 3, editable: true },
                    { id: 'how-it-works', type: 'section', title: 'How It Works', visible: true, order: 4, editable: true },
                    { id: 'testimonials', type: 'section', title: 'Testimonials', visible: true, order: 5, editable: true },
                    { id: 'cta', type: 'section', title: 'CTA Section', visible: true, order: 6, editable: true }
                ],
                investors: [
                    { id: 'hero', type: 'hero', title: 'Hero Section', visible: true, order: 1, editable: false },
                    { id: 'investing-without-borders', type: 'section', title: 'Investing Without Borders', visible: true, order: 2, editable: true },
                    { id: 'stats', type: 'section', title: 'Investment Stats', visible: true, order: 3, editable: true }
                ],
                agencies: [
                    { id: 'hero', type: 'hero', title: 'Hero Section', visible: true, order: 1, editable: false },
                    { id: 'agency-live-selling', type: 'section', title: 'Live Selling & Social Media', visible: true, order: 2, editable: true },
                    { id: 'agency-white-label-offer', type: 'section', title: 'White Label Offer', visible: true, order: 3, editable: true },
                    { id: 'stats', type: 'section', title: 'Enterprise Stats', visible: true, order: 4, editable: true },
                    { id: 'enterprise-features', type: 'section', title: 'Enterprise Features', visible: true, order: 5, editable: true }
                ],
                about: [
                    { id: 'hero', type: 'hero', title: 'Hero Section', visible: true, order: 1, editable: false },
                    { id: 'about-content', type: 'section', title: 'About Content', visible: true, order: 2, editable: true }
                ]
            };

            admin.updatePageStructure(currentPageId, defaultStructures[currentPageId] || []);
            renderPageStructure();
            showNotification('Page structure reset to default!');
        }

        // Show notification
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'warning' ? 'bg-yellow-500' : 'bg-blue-500';
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Add section form handler
        document.addEventListener('DOMContentLoaded', function() {
            const addSectionForm = document.getElementById('addSectionForm');
            if (addSectionForm) {
                addSectionForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const formData = new FormData(e.target);
                    const sectionData = {
                        id: formData.get('sectionId'),
                        title: formData.get('sectionTitle'),
                        type: formData.get('sectionType')
                    };

                    const admin = window.estalaraAdmin;
                    if (!admin) return;

                    admin.addSection(currentPageId, sectionData);
                    hideAddSectionModal();
                    renderPageStructure();
                    showNotification('Section added successfully! Remember to add the corresponding HTML to the page.');
                });
            }
        });

        // Initialize page structure editor when section is shown
        const originalShowSection = showSection;
        showSection = function(sectionId) {
            originalShowSection(sectionId);
            if (sectionId === 'page-structure') {
                // Wait a bit for estalaraAdmin to be initialized
                setTimeout(() => {
                    loadPageStructureEditor();
                }, 100);
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            showSection('dashboard');
            // Attach page select listener and load initial values
            const pageSelectEl = document.getElementById('pageSelect');
            if (pageSelectEl) {
                pageSelectEl.addEventListener('change', loadPageSectionFields);
                loadPageSectionFields();
            }
            // Populate footer text field
            const footerInput = document.getElementById('footerText');
            if (footerInput) {
                footerInput.value = (adminData.content && adminData.content.footerText) || '';
            }
            
            // General settings form handler
            const generalSettingsForm = document.getElementById('general-settings-form');
            if (generalSettingsForm) {
                generalSettingsForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveGeneralSettings();
                });
            }
            
            // Logo URL input handler for live preview
            const logoUrlInput = document.getElementById('logo-url');
            if (logoUrlInput && !logoUrlInput.dataset.listenerAttached) {
                console.log('‚úì Attaching logo URL input handler');
                
                // Debounce the preview update to avoid too many updates while typing
                let previewTimeout;
                logoUrlInput.addEventListener('input', function(e) {
                    clearTimeout(previewTimeout);
                    previewTimeout = setTimeout(() => {
                        console.log('üìù Logo URL input changed:', e.target.value);
                        updateLogoPreview(e.target.value);
                    }, 500); // Wait 500ms after user stops typing
                });
                
                // Also update on blur (when user leaves the field)
                logoUrlInput.addEventListener('blur', function(e) {
                    clearTimeout(previewTimeout);
                    console.log('üëÅÔ∏è Logo URL field blur, updating preview');
                    updateLogoPreview(e.target.value);
                });
                
                logoUrlInput.dataset.listenerAttached = 'true';
                console.log('‚úì Logo URL input handler attached with debouncing');
            } else if (logoUrlInput) {
                console.log('‚úì Logo URL input handler already attached, skipping');
            }
            
            // Logo file upload handler
            const logoUploadInput = document.getElementById('logo-upload');
            if (logoUploadInput && !logoUploadInput.dataset.listenerAttached) {
                console.log('‚úì Attaching logo upload handler');
                logoUploadInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Validate file is an image
                        if (!file.type.startsWith('image/')) {
                            alert('Please upload an image file (PNG, JPG, SVG, etc.)');
                            return;
                        }
                        
                        // Convert to data URL
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const dataUrl = event.target.result;
                            // Update the logo URL input with the data URL
                            document.getElementById('logo-url').value = dataUrl;
                            // Update the preview
                            updateLogoPreview(dataUrl);
                            // Show success message
                            showNotification('Logo uploaded successfully! Click "Save Changes" to apply it to your website.');
                        };
                        reader.onerror = function() {
                            alert('Failed to read the file. Please try again.');
                        };
                        reader.readAsDataURL(file);
                    }
                });
                logoUploadInput.dataset.listenerAttached = 'true';
                console.log('‚úì Logo upload handler attached');
            } else if (logoUploadInput) {
                console.log('‚úì Logo upload handler already attached, skipping');
            }
        });
    </script>
</body>
</html>